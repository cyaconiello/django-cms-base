#!/bin/bash

# set up paths
work_tree=<%= node[:app][:paths][:site] %>/app
git_dir=<%= node[:app][:paths][:site] %>/landcare.git

# handle git push
echo "Deploying into $work_tree"
git --work-tree=$work_tree --git-dir=$git_dir checkout -f
cd $work_tree

# activate the environment
source <%= node[:app][:paths][:site] %>/venv/bin/activate

# install requirements
echo "installing python requirements"
pip install -r <%= node[:app][:paths][:site] %>/app/requirements.txt

# Build assets
echo "building frontend assets"
cd <%= node[:app][:paths][:site] %>/app && npm install && npm run build

# handle django specific deployment tasks
echo "running Django management commands"
python <%= node[:app][:paths][:site] %>/app/manage.py syncdb --settings=<%= node[:app][:DJANGO_SETTINGS_MODULE] %>
python <%= node[:app][:paths][:site] %>/app/manage.py migrate --settings=<%= node[:app][:DJANGO_SETTINGS_MODULE] %>
python <%= node[:app][:paths][:site] %>/app/manage.py collectstatic --noinput --settings=<%= node[:app][:DJANGO_SETTINGS_MODULE] %>


# quit the virtual env
deactivate

#restart uwsgi
echo "restarting web service"
sudo service uwsgi restart

